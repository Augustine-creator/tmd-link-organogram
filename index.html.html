<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMD Organogram 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #facc15;
            --background-color: #f8fafc;
            --text-dark: #1e293b;
            --text-light: #ffffff;
            --shadow-color: rgba(37, 99, 235, 0.1);
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-color);
            color: var(--text-dark);
            transition: all 0.5s ease;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            position: relative;
            border: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            backdrop-filter: blur(10px);
        }

        .logo {
            height: 80px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-dark);
            margin-top: 10px;
            font-weight: 400;
        }

        #organogram {
            width: 100%;
            height: 800px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            overflow: auto;
            border: 1px solid var(--border-color);
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.1);
        }

        .node rect {
            stroke-width: 2px;
            stroke: var(--border-color);
            transition: all 0.3s ease;
        }

        .node.excom rect {
            stroke: var(--secondary-color);
            stroke-width: 3px;
        }

        .node text {
            font-size: 12px;
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: middle;
            fill: var(--text-light);
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke-width: 2px;
            stroke-linecap: round;
            transition: all 0.3s ease;
        }

        .data-flow {
            stroke-dasharray: 5, 5;
            animation: dash 2s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -20;
            }
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            backdrop-filter: blur(10px);
        }

        button, select {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover, select:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        #themeSelect {
            appearance: none;
            background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='5' fill='white'><path d='M0 0h10l-5 5z'/></svg>") no-repeat right 10px center;
            background-color: var(--primary-color);
            padding-right: 30px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        #searchInput {
            padding: 10px 15px;
            width: 300px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }

        #searchResults {
            position: absolute;
            top: 50px;
            width: 330px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: var(--secondary-color);
            color: var(--text-dark);
        }

        .search-result-name {
            font-weight: 600;
            position: relative;
        }

        .search-result-name::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .search-result-item:hover .search-result-name::after {
            width: 100%;
        }

        .search-result-role {
            font-size: 12px;
            color: #64748b;
        }

        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 13px;
            max-width: 280px;
            z-index: 100;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            transform: translateY(10px);
            backdrop-filter: blur(10px);
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tooltip-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tooltip-label {
            font-weight: 500;
            color: #64748b;
        }

        .legend {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .legend-title {
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stats-container {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 8px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #64748b;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-content h2 {
            margin: 0 0 15px;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .modal-content label {
            display: block;
            margin: 10px 0 5px;
            font-weight: 500;
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-content button {
            margin-top: 15px;
            width: 100%;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }

        .preview-item {
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .preview-item img {
            max-width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .preview-item label {
            display: block;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Theme-specific styles */
        body.classic {
            --primary-color: #2563eb;
            --secondary-color: #facc15;
            --background-color: #f8fafc;
            --text-dark: #1e293b;
            --border-color: #e2e8f0;
        }

        body.sunset {
            --primary-color: #ef4444;
            --secondary-color: #f97316;
            --background-color: #fef3c7;
            --text-dark: #7f1d1d;
            --border-color: #fed7aa;
        }

        body.amethyst {
            --primary-color: #8b5cf6;
            --secondary-color: #d946ef;
            --background-color: #f5f3ff;
            --text-dark: #4c1d95;
            --border-color: #ddd6fe;
        }

        body.ocean {
            --primary-color: #0284c7;
            --secondary-color: #14b8a6;
            --background-color: #e0f2fe;
            --text-dark: #0f766e;
            --border-color: #bae6fd;
        }

        body.forest {
            --primary-color: #15803d;
            --secondary-color: #ca8a04;
            --background-color: #ecfdf5;
            --text-dark: #14532d;
            --border-color: #a7f3d0;
        }

        /* Department colors */
        .classic .dept-gm-aftersales rect { fill: #2563eb; }
        .classic .dept-gm-vehicle-sales rect { fill: #7c3aed; }
        .classic .dept-customer-experience rect { fill: #059669; }
        .classic .dept-executive rect { fill: #d97706; }
        .classic .dept-gm-finance rect { fill: #dc2626; }
        .classic .dept-hr-operations rect { fill: #4f46e5; }
        .classic .dept-board rect { fill: #1e40af; }

        .sunset .dept-gm-aftersales rect { fill: #ef4444; }
        .sunset .dept-gm-vehicle-sales rect { fill: #f97316; }
        .sunset .dept-customer-experience rect { fill: #ea580c; }
        .sunset .dept-executive rect { fill: #b91c1c; }
        .sunset .dept-gm-finance rect { fill: #dc2626; }
        .sunset .dept-hr-operations rect { fill: #9a3412; }
        .sunset .dept-board rect { fill: #7f1d1d; }

        .amethyst .dept-gm-aftersales rect { fill: #8b5cf6; }
        .amethyst .dept-gm-vehicle-sales rect { fill: #d946ef; }
        .amethyst .dept-customer-experience rect { fill: #a21caf; }
        .amethyst .dept-executive rect { fill: #7e22ce; }
        .amethyst .dept-gm-finance rect { fill: #c026d3; }
        .amethyst .dept-hr-operations rect { fill: #6b21a8; }
        .amethyst .dept-board rect { fill: #4c1d95; }

        .ocean .dept-gm-aftersales rect { fill: #0284c7; }
        .ocean .dept-gm-vehicle-sales rect { fill: #14b8a6; }
        .ocean .dept-customer-experience rect { fill: #0d9488; }
        .ocean .dept-executive rect { fill: #0369a1; }
        .ocean .dept-gm-finance rect { fill: #075985; }
        .ocean .dept-hr-operations rect { fill: #0e7490; }
        .ocean .dept-board rect { fill: #0f766e; }

        .forest .dept-gm-aftersales rect { fill: #15803d; }
        .forest .dept-gm-vehicle-sales rect { fill: #16a34a; }
        .forest .dept-customer-experience rect { fill: #22c55e; }
        .forest .dept-executive rect { fill: #ca8a04; }
        .forest .dept-gm-finance rect { fill: #166534; }
        .forest .dept-hr-operations rect { fill: #14532d; }
        .forest .dept-board rect { fill: #052e16; }

        /* Link colors */
        .classic .dept-gm-aftersales-link { stroke: #2563eb; }
        .classic .dept-gm-vehicle-sales-link { stroke: #7c3aed; }
        .classic .dept-customer-experience-link { stroke: #059669; }
        .classic .dept-executive-link { stroke: #d97706; }
        .classic .dept-gm-finance-link { stroke: #dc2626; }
        .classic .dept-hr-operations-link { stroke: #4f46e5; }
        .classic .dept-board-link { stroke: #1e40af; }

        .sunset .dept-gm-aftersales-link { stroke: #ef4444; }
        .sunset .dept-gm-vehicle-sales-link { stroke: #f97316; }
        .sunset .dept-customer-experience-link { stroke: #ea580c; }
        .sunset .dept-executive-link { stroke: #b91c1c; }
        .sunset .dept-gm-finance-link { stroke: #dc2626; }
        .sunset .dept-hr-operations-link { stroke: #9a3412; }
        .sunset .dept-board-link { stroke: #7f1d1d; }

        .amethyst .dept-gm-aftersales-link { stroke: #8b5cf6; }
        .amethyst .dept-gm-vehicle-sales-link { stroke: #d946ef; }
        .amethyst .dept-customer-experience-link { stroke: #a21caf; }
        .amethyst .dept-executive-link { stroke: #7e22ce; }
        .amethyst .dept-gm-finance-link { stroke: #c026d3; }
        .amethyst .dept-hr-operations-link { stroke: #6b21a8; }
        .amethyst .dept-board-link { stroke: #4c1d95; }

        .ocean .dept-gm-aftersales-link { stroke: #0284c7; }
        .ocean .dept-gm-vehicle-sales-link { stroke: #14b8a6; }
        .ocean .dept-customer-experience-link { stroke: #0d9488; }
        .ocean .dept-executive-link { stroke: #0369a1; }
        .ocean .dept-gm-finance-link { stroke: #075985; }
        .ocean .dept-hr-operations-link { stroke: #0e7490; }
        .ocean .dept-board-link { stroke: #0f766e; }

        .forest .dept-gm-aftersales-link { stroke: #15803d; }
        .forest .dept-gm-vehicle-sales-link { stroke: #16a34a; }
        .forest .dept-customer-experience-link { stroke: #22c55e; }
        .forest .dept-executive-link { stroke: #ca8a04; }
        .forest .dept-gm-finance-link { stroke: #166534; }
        .forest .dept-hr-operations-link { stroke: #14532d; }
        .forest .dept-board-link { stroke: #052e16; }

        /* Animations */
        @keyframes nodeEntrance {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .node-entering {
            animation: nodeEntrance 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes linkDraw {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        .link-drawing {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: linkDraw 1.2s ease-out forwards;
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(10); opacity: 0; }
        }

        .ripple {
            position: fixed;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, var(--primary-color), transparent);
            border-radius: 50%;
            pointer-events: none;
            animation: ripple 0.8s ease-out forwards;
        }
    </style>
</head>
<body class="classic">
    <div class="container">
        <div class="header">
            <img id="logo" class="logo" src="data:image/svg+xml,%3Csvg viewBox='0 0 200 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='logoGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232563eb;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23facc15;stop-opacity:1' /%3E%3C/linearGradient%3E%3Cfilter id='glow' x='-50%25' y='-50%25' width='200%25' height='200%25'%3E%3CfeGaussianBlur stdDeviation='4' result='blur' /%3E%3CfeFlood flood-color='%23facc15' result='glow-color' /%3E%3CfeComposite in='glow-color' in2='blur' operator='in' result='glow-blur' /%3E%3CfeMerge%3E%3CfeMergeNode in='glow-blur' /%3E%3CfeMergeNode in='SourceGraphic' /%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Ccircle cx='100' cy='50' r='40' fill='url(%23logoGradient)' /%3E%3Ctext x='100' y='65' font-size='45' font-weight='bold' text-anchor='middle' fill='white' filter='url(%23glow)'%3ETMD%3C/text%3E%3C/svg%3E" alt="TMD Logo">
            <h1>TMD Organogram 2025</h1>
            <div class="subtitle">Organizational Structure</div>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search roles or departments..." aria-label="Search organogram">
            <div id="searchResults"></div>
        </div>

        <div class="controls" data-tilt data-tilt-max="10" data-tilt-speed="400" data-tilt-perspective="1000">
            <button id="expandAll" aria-label="Expand All">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <polyline points="9 21 3 21 3 15"></polyline>
                    <line x1="21" y1="3" x2="14" y2="10"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
                Expand All
            </button>
            <button id="collapseAll" aria-label="Collapse All">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="4 14 10 14 10 20"></polyline>
                    <polyline points="20 10 14 10 14 4"></polyline>
                    <line x1="14" y1="10" x2="21" y2="3"></line>
                    <line x1="3" y1="21" x2="10" y2="14"></line>
                </svg>
                Collapse All
            </button>
            <button id="addRole" aria-label="Add Role">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="17" y1="11" x2="23" y2="11"></line>
                </svg>
                Add Role
            </button>
            <button id="showDataFlow" aria-label="Show Data Flow">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8V5a3 3 0 0 0-3-3H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h3"></path>
                    <path d="M10 8h8"></path>
                    <path d="M15 11l3-3-3-3"></path>
                </svg>
                Show Data Flow
            </button>
            <select id="themeSelect" aria-label="Select Theme">
                <option value="classic">Classic</option>
                <option value="sunset">Sunset</option>
                <option value="amethyst">Amethyst</option>
                <option value="ocean">Ocean</option>
                <option value="forest">Forest</option>
            </select>
            <button id="voiceControl" aria-label="Voice Control">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1v22"></path>
                    <path d="M17 7h-10"></path>
                    <path d="M15 11h-6"></path>
                </svg>
                Start Voice Control
            </button>
            <button id="exportPDF" aria-label="Export to PDF">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2v6h6"></path>
                    <path d="M14 22v-6h6"></path>
                    <path d="M4 2h10"></path>
                    <path d="M4 22h10"></path>
                    <path d="M10 12h4"></path>
                </svg>
                Export to PDF
            </button>
            <input type="file" id="logoUpload" accept="image/png,image/jpeg" style="display: none;" aria-label="Upload Logo">
            <button id="uploadLogo" aria-label="Upload TMD Logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload TMD Logo
            </button>
        </div>

        <div id="organogram"></div>

        <div class="legend">
            <div class="legend-title">Department Color Legend</div>
            <div class="legend-item" data-dept="board">
                <div class="legend-color" style="background-color: #1e40af;"></div>
                <span>Board of Directors & Chairman</span>
            </div>
            <div class="legend-item" data-dept="executive">
                <div class="legend-color" style="background-color: #d97706;"></div>
                <span>Executive Coordinator</span>
            </div>
            <div class="legend-item" data-dept="gm-aftersales">
                <div class="legend-color" style="background-color: #2563eb;"></div>
                <span>Aftersales</span>
            </div>
            <div class="legend-item" data-dept="gm-vehicle-sales">
                <div class="legend-color" style="background-color: #7c3aed;"></div>
                <span>Vehicle Sales</span>
            </div>
            <div class="legend-item" data-dept="customer-experience">
                <div class="legend-color" style="background-color: #059669;"></div>
                <span>Customer Experience</span>
            </div>
            <div class="legend-item" data-dept="gm-finance">
                <div class="legend-color" style="background-color: #dc2626;"></div>
                <span>Finance & Strategy</span>
            </div>
            <div class="legend-item" data-dept="hr-operations">
                <div class="legend-color" style="background-color: #4f46e5;"></div>
                <span>HR & Operations</span>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Total Roles</div>
                <div class="stat-value" id="totalRoles">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Departments</div>
                <div class="stat-value">7</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">EXCOM Members</div>
                <div class="stat-value">6</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Staff Roles</div>
                <div class="stat-value" id="staffRoles">0</div>
            </div>
        </div>

        <div class="footer">
            Â© 2025 TMD Organogram | Updated May 2025
        </div>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-content"></div>
    </div>

    <div class="modal" id="addRoleModal">
        <div class="modal-content">
            <h2>Add New Role</h2>
            <label for="excomSelect">Select EXCOM Member</label>
            <select id="excomSelect">
                <option value="">Select EXCOM Member</option>
            </select>
            <label for="parentRole">Parent Role (Optional)</label>
            <select id="parentRole">
                <option value="">None (Direct to EXCOM)</option>
            </select>
            <label for="roleName">Role Name</label>
            <input type="text" id="roleName" placeholder="Enter role name">
            <label for="roleDepartment">Department</label>
            <select id="roleDepartment">
                <option value="gm-aftersales">Aftersales</option>
                <option value="gm-vehicle-sales">Vehicle Sales</option>
                <option value="customer-experience">Customer Experience</option>
                <option value="executive">Executive Coordinator</option>
                <option value="gm-finance">Finance & Strategy</option>
                <option value="hr-operations">HR & Operations</option>
            </select>
            <label for="roleLevel">Level</label>
            <select id="roleLevel">
                <option value="manager">Manager</option>
                <option value="team-lead">Team Lead</option>
                <option value="staff">Staff</option>
            </select>
            <label for="roleDescription">Description</label>
            <input type="text" id="roleDescription" placeholder="Enter role description">
            <button id="submitRole">Add Role</button>
            <button id="closeModal">Cancel</button>
        </div>
    </div>

    <div class="modal" id="exportPDFModal">
        <div class="modal-content">
            <h2>Export to PDF</h2>
            <div class="preview-container">
                <div class="preview-item">
                    <label>A4 (297mm x 210mm)</label>
                    <img id="previewA4" alt="A4 Preview">
                    <button class="downloadPDF" data-size="a4">Download A4</button>
                </div>
                <div class="preview-item">
                    <label>A3 (420mm x 297mm)</label>
                    <img id="previewA3" alt="A3 Preview">
                    <button class="downloadPDF" data-size="a3">Download A3</button>
                </div>
                <div class="preview-item">
                    <label>Custom Size</label>
                    <input type="number" id="customWidth" placeholder="Width (mm)" min="100">
                    <input type="number" id="customHeight" placeholder="Height (mm)" min="100">
                    <img id="previewCustom" alt="Custom Preview">
                    <button class="downloadPDF" data-size="custom">Download Custom</button>
                </div>
            </div>
            <button id="closePDFModal">Cancel</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Organization data structure
        let orgData = {
            name: "Board of Directors",
            role: "Governance",
            department: "board",
            level: "executive",
            description: "Provides strategic direction and oversight to the company.",
            children: [{
                name: "Chairman",
                role: "Leadership",
                department: "board",
                level: "executive",
                description: "Leads the Board of Directors and oversees corporate governance.",
                children: [{
                    name: "Managing Director",
                    role: "Company Leadership",
                    department: "board",
                    level: "executive",
                    description: "Chief executive responsible for overall company management and strategy implementation.",
                    children: [
                        {
                            name: "GM Aftersales (EXCOM)",
                            role: "General Manager",
                            department: "gm-aftersales",
                            level: "general",
                            excom: true,
                            description: "Oversees all aftersales operations including service, parts, and branch operations.",
                            children: [
                                {
                                    name: "Branch Team Leaders",
                                    role: "Team Leadership",
                                    department: "gm-aftersales",
                                    level: "manager",
                                    description: "Manage branch operations and lead branch teams.",
                                    children: [
                                        {
                                            name: "Branch Administrators",
                                            role: "Administration",
                                            department: "gm-aftersales",
                                            level: "team-lead",
                                            description: "Handle administrative functions at branch level.",
                                            children: [
                                                { name: "Sales Consultants", role: "Sales Support", department: "gm-aftersales", level: "staff", description: "Front-line sales staff engaging with customers at branch level." },
                                                { name: "Branch Service Advisors", role: "Service Support", department: "gm-aftersales", level: "staff", description: "Interface between customers and technical staff for service operations." },
                                                { name: "Branch Parts Advisors", role: "Parts Support", department: "gm-aftersales", level: "staff", description: "Manage parts inventory and fulfillment at branch level." }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    name: "Aftersales Manager",
                                    role: "Department Management",
                                    department: "gm-aftersales",
                                    level: "manager",
                                    description: "Manages overall aftersales strategy and marketing initiatives.",
                                    children: [
                                        { name: "After Sales Marketers", role: "Marketing Support", department: "gm-aftersales", level: "staff", description: "Develop and implement marketing strategies for aftersales products and services." }
                                    ]
                                },
                                {
                                    name: "Manager Aftersales Operations",
                                    role: "Operations Management",
                                    department: "gm-aftersales",
                                    level: "manager",
                                    description: "Oversees day-to-day operations of workshop and service delivery.",
                                    children: [
                                        {
                                            name: "Workshop Controllers",
                                            role: "Workshop Management",
                                            department: "gm-aftersales",
                                            level: "team-lead",
                                            description: "Manage workshop scheduling, efficiency, and quality control.",
                                            children: [
                                                { name: "Technicians", role: "Technical Support", department: "gm-aftersales", level: "staff", description: "Perform vehicle repairs, maintenance, and diagnostics." }
                                            ]
                                        },
                                        { name: "Service Advisors", role: "Customer Service", department: "gm-aftersales", level: "staff", description: "Assist customers with service inquiries and coordinate with technical staff." }
                                    ]
                                },
                                {
                                    name: "Parts Manager",
                                    role: "Parts Management",
                                    department: "gm-aftersales",
                                    level: "manager",
                                    description: "Oversees parts inventory, procurement, and distribution.",
                                    children: [
                                        { name: "Sales Administrative Assistants", role: "Administrative Support", department: "gm-aftersales", level: "staff", description: "Support parts sales and inventory management with administrative tasks." }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "GM Vehicle Sales (EXCOM)",
                            role: "General Manager",
                            department: "gm-vehicle-sales",
                            level: "general",
                            excom: true,
                            description: "Manages vehicle sales operations and sales strategies.",
                            children: [
                                {
                                    name: "Manager Sales Administration",
                                    role: "Administration Management",
                                    department: "gm-vehicle-sales",
                                    level: "manager",
                                    description: "Oversees sales administration processes and documentation.",
                                    children: [
                                        { name: "Sales Administrative Assistant", role: "Administrative Support", department: "gm-vehicle-sales", level: "staff", description: "Handles administrative tasks for vehicle sales operations." }
                                    ]
                                },
                                {
                                    name: "Sales & Marketing Manager",
                                    role: "Sales and Marketing",
                                    department: "gm-vehicle-sales",
                                    level: "manager",
                                    description: "Develops and implements sales and marketing strategies for vehicle sales.",
                                    children: [
                                        { name: "Digital Marketing", role: "Marketing Support", department: "gm-vehicle-sales", level: "staff", description: "Manages digital marketing campaigns and online presence." },
                                        { name: "Sales Aftersales Consultants", role: "Sales Support", department: "gm-vehicle-sales", level: "staff", description: "Support aftersales services for vehicle sales customers." }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "Customer Experience Manager (EXCOM)",
                            role: "Customer Experience",
                            department: "customer-experience",
                            level: "manager",
                            excom: true,
                            description: "Ensures high-quality customer interactions and satisfaction.",
                            children: [
                                {
                                    name: "Care Coordinator",
                                    role: "Customer Care",
                                    department: "customer-experience",
                                    level: "team-lead",
                                    description: "Coordinates customer care initiatives and feedback.",
                                    children: [
                                        { name: "Customer Experience Advisors", role: "Customer Support", department: "customer-experience", level: "staff", description: "Provide direct support and advice to customers." }
                                    ]
                                }
                            ]
                        },
                        {
                            name: "Executive Coordinator (EXCOM)",
                            role: "Executive Support",
                            department: "executive",
                            level: "manager",
                            excom: true,
                            description: "Provides administrative and strategic support to the Managing Director."
                        },
                        {
                            name: "GM Finance and Strategy (EXCOM)",
                            role: "General Manager",
                            department: "gm-finance",
                            level: "general",
                            excom: true,
                            description: "Oversees financial operations and strategic planning.",
                            children: [
                                {
                                    name: "Accountant Aftersales",
                                    role: "Accounting",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Manages financial reporting for aftersales operations.",
                                    children: [
                                        { name: "Account Assistant", role: "Accounting Support", department: "gm-finance", level: "staff", description: "Assists with aftersales accounting tasks." }
                                    ]
                                },
                                {
                                    name: "Accountant Vehicle Sales",
                                    role: "Accounting",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Manages financial reporting for vehicle sales operations.",
                                    children: [
                                        { name: "Account Assistant", role: "Accounting Support", department: "gm-finance", level: "staff", description: "Assists with vehicle sales accounting tasks." }
                                    ]
                                },
                                {
                                    name: "Management Accountant",
                                    role: "Accounting",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Provides strategic financial analysis and reporting.",
                                    children: [
                                        { name: "Account Assistant", role: "Accounting Support", department: "gm-finance", level: "staff", description: "Assists with management accounting tasks." }
                                    ]
                                },
                                {
                                    name: "Procurement Manager",
                                    role: "Procurement",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Manages procurement processes and vendor relationships.",
                                    children: [
                                        { name: "Account Assistant", role: "Procurement Support", department: "gm-finance", level: "staff", description: "Assists with procurement administrative tasks." }
                                    ]
                                },
                                {
                                    name: "IT Administrator",
                                    role: "IT Support",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Manages IT infrastructure and systems."
                                },
                                {
                                    name: "Business Data Analyst",
                                    role: "Data Analysis",
                                    department: "gm-finance",
                                    level: "manager",
                                    description: "Analyzes business data to support strategic decisions."
                                }
                            ]
                        },
                        {
                            name: "HR & Operations (EXCOM)",
                            role: "Human Resources",
                            department: "hr-operations",
                            level: "general",
                            excom: true,
                            description: "Manages human resources and operational support functions.",
                            children: [
                                {
                                    name: "HR Officer",
                                    role: "HR Management",
                                    department: "hr-operations",
                                    level: "manager",
                                    description: "Handles HR policies, recruitment, and employee relations.",
                                    children: [
                                        { name: "Receptionist", role: "Administrative Support", department: "hr-operations", level: "staff", description: "Manages front desk and visitor interactions." },
                                        { name: "Messenger", role: "Support Staff", department: "hr-operations", level: "staff", description: "Handles internal and external deliveries." },
                                        { name: "Cleaners", role: "Support Staff", department: "hr-operations", level: "staff", description: "Maintains office cleanliness and hygiene." },
                                        { name: "Outsourced Firms", role: "External Support", department: "hr-operations", level: "staff", description: "Manages relationships with outsourced service providers." },
                                        { name: "Drivers", role: "Transport Support", department: "hr-operations", level: "staff", description: "Provides transportation services for company operations." }
                                    ]
                                }
                            ]
                        }
                    ]
                }]
            }]
        };

        // Load from session storage if available
        if (sessionStorage.getItem('orgData')) {
            orgData = JSON.parse(sessionStorage.getItem('orgData'));
        }

        // D3.js setup
        const width = 1800;
        const height = 800;
        const nodeWidth = 180;
        const nodeHeight = 70;
        let zoomLevel = 1;
        let showDataFlow = false;

        const svg = d3.select("#organogram")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(d3.zoom().scaleExtent([0.3, 3]).on("zoom", ({ transform }) => {
                zoomLevel = transform.k;
                g.attr("transform", transform);
            }))
            .append("g");

        svg.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 0 10 10")
            .attr("refX", 5)
            .attr("refY", 5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto-start-reverse")
            .append("path")
            .attr("d", "M 0 0 L 10 5 L 0 10 z")
            .attr("fill", "var(--primary-color)");

        const g = svg.append("g");

        const tree = d3.tree()
            .nodeSize([nodeWidth + 30, nodeHeight + 50]);

        let root = d3.hierarchy(orgData);
        root.x0 = width / 2;
        root.y0 = 0;

        root.descendants().forEach((d, i) => {
            d.id = i;
            d._children = d.children;
            if (d.depth > 2) d.children = null;
        });

        function update(source) {
            const duration = 650;
            const nodes = root.descendants();
            const links = root.links();

            tree(root);

            nodes.forEach(d => {
                d.y = d.depth * 160;
            });

            const node = g.selectAll(".node")
                .data(nodes, d => d.id);

            const nodeEnter = node.enter()
                .append("g")
                .attr("class", d => `node dept-${d.data.department} ${d.data.excom ? 'excom' : ''} node-entering`)
                .attr("transform", d => `translate(${source.x0},${source.y0})`)
                .call(d3.drag()
                    .on("start", dragStart)
                    .on("drag", dragged)
                    .on("end", dragEnd))
                .on("click", (event, d) => {
                    if (d._children) {
                        d.children = d.children ? null : d._children;
                        update(d);
                    }
                })
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            nodeEnter.append("rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight)
                .attr("x", -nodeWidth / 2)
                .attr("y", -nodeHeight / 2)
                .attr("rx", 8);

            nodeEnter.append("text")
                .attr("dy", "-5")
                .text(d => d.data.name);

            nodeEnter.append("text")
                .attr("dy", "15")
                .text(d => d.data.role);

            const nodeUpdate = node.merge(nodeEnter)
                .transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .attr("class", d => `node dept-${d.data.department} ${d.data.excom ? 'excom' : ''}`);

            node.exit()
                .transition()
                .duration(duration)
                .attr("transform", d => `translate(${source.x},${source.y})`)
                .remove();

            const link = g.selectAll(".link")
                .data(links, d => d.target.id);

            const linkEnter = link.enter()
                .append("path")
                .attr("class", d => `link dept-${d.target.data.department}-link link-drawing ${showDataFlow ? 'data-flow' : ''}`)
                .attr("marker-end", "url(#arrow)")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal({ source: o, target: o });
                });

            link.merge(linkEnter)
                .transition()
                .duration(duration)
                .attr("d", diagonal)
                .attr("class", d => `link dept-${d.target.data.department}-link ${showDataFlow ? 'data-flow' : ''}`);

            link.exit()
                .transition()
                .duration(duration)
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return diagonal({ source: o, target: o });
                })
                .remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });

            updateStats(nodes);
            updatePDFPreviews();
        }

        function diagonal({ source, target }) {
            return `M ${source.x} ${source.y + nodeHeight / 2}
                    C ${source.x} ${source.y + 80},
                      ${target.x} ${target.y - 80},
                      ${target.x} ${target.y - nodeHeight / 2}`;
        }

        function dragStart(event, d) {
            d3.select(this).raise();
        }

        function dragged(event, d) {
            d.x = event.x;
            d.y = event.y;
            update(d);
        }

        function dragEnd(event, d) {
            update(d);
        }

        function showTooltip(event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.select(".tooltip-title").text(d.data.name);
            tooltip.select(".tooltip-content")
                .html(`
                    <div><span class="tooltip-label">Role:</span> ${d.data.role}</div>
                    <div><span class="tooltip-label">Department:</span> ${d.data.department}</div>
                    <div><span class="tooltip-label">Description:</span> ${d.data.description}</div>
                    ${d.data.excom ? '<div><span class="tooltip-label">Status:</span> EXCOM Member</div>' : ''}
                `);
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY - 5) + "px")
                   .style("opacity", 1)
                   .style("transform", "translateY(0)");
        }

        function hideTooltip() {
            d3.select("#tooltip")
                .style("opacity", 0)
                .style("transform", "translateY(10px)");
        }

        function updateStats(nodes) {
            const total = nodes.length;
            const staff = nodes.filter(d => d.data.level === "staff").length;

            d3.select("#totalRoles").text(total);
            d3.select("#staffRoles").text(staff);
        }

        // Theme Selection with Ripple Effect
        d3.select("#themeSelect").on("change", function(event) {
            const ripple = d3.select("body")
                .append("div")
                .attr("class", "ripple")
                .style("left", (event.pageX - 50) + "px")
                .style("top", (event.pageY - 50) + "px");

            setTimeout(() => {
                document.body.className = this.value;
                ripple.remove();
            }, 800);
        });

        // Expand and Collapse
        d3.select("#expandAll").on("click", () => {
            root.descendants().forEach(d => {
                d.children = d._children;
            });
            update(root);
        });

        d3.select("#collapseAll").on("click", () => {
            root.descendants().forEach(d => {
                if (d.depth > 2) d.children = null;
            });
            update(root);
        });

        // Data Flow Toggle
        d3.select("#showDataFlow").on("click", () => {
            showDataFlow = !showDataFlow;
            d3.select("#showDataFlow").text(showDataFlow ? "Hide Data Flow" : "Show Data Flow");
            update(root);
        });

        // Voice Control
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;

        d3.select("#voiceControl").on("click", () => {
            recognition.start();
            d3.select("#voiceControl").text("Listening...");
        });

        recognition.onresult = function(event) {
            const command = event.results[0][0].transcript.toLowerCase();
            d3.select("#voiceControl").text("Start Voice Control");

            if (command.includes("expand all")) {
                d3.select("#expandAll").dispatch("click");
            } else if (command.includes("collapse all")) {
                d3.select("#collapseAll").dispatch("click");
            } else if (command.includes("add role")) {
                d3.select("#addRole").dispatch("click");
            } else if (command.includes("show data flow") || command.includes("hide data flow")) {
                d3.select("#showDataFlow").dispatch("click");
            } else if (command.includes("export pdf")) {
                if (command.includes("a4")) {
                    exportPDF("a4");
                } else if (command.includes("a3")) {
                    exportPDF("a3");
                } else {
                    d3.select("#exportPDF").dispatch("click");
                }
            } else if (command.includes("search")) {
                const query = command.replace("search", "").trim();
                d3.select("#searchInput").property("value", query).dispatch("input");
            }
        };

        recognition.onend = () => {
            d3.select("#voiceControl").text("Start Voice Control");
        };

        // Role Addition
        d3.select("#addRole").on("click", () => {
            const modal = d3.select("#addRoleModal");
            modal.style("display", "flex");

            const excomSelect = d3.select("#excomSelect");
            const parentRoleSelect = d3.select("#parentRole");

            const excomMembers = root.descendants().filter(d => d.data.excom);
            excomSelect.selectAll("option").remove();
            excomSelect.append("option").attr("value", "").text("Select EXCOM Member");
            excomMembers.forEach(d => {
                excomSelect.append("option")
                    .attr("value", d.data.name)
                    .text(d.data.name);
            });

            excomSelect.on("change", function() {
                const selectedExcom = this.value;
                parentRoleSelect.selectAll("option").remove();
                parentRoleSelect.append("option").attr("value", "").text("None (Direct to EXCOM)");

                if (selectedExcom) {
                    const excomNode = root.descendants().find(d => d.data.name === selectedExcom);
                    if (excomNode && excomNode._children) {
                        excomNode._children.forEach(child => {
                            parentRoleSelect.append("option")
                                .attr("value", child.name)
                                .text(child.name);
                        });
                    }
                }
            });
        });

        d3.select("#submitRole").on("click", () => {
            const excom = d3.select("#excomSelect").property("value");
            const parentRole = d3.select("#parentRole").property("value");
            const roleName = d3.select("#roleName").property("value");
            const department = d3.select("#roleDepartment").property("value");
            const level = d3.select("#roleLevel").property("value");
            const description = d3.select("#roleDescription").property("value");

            if (!excom || !roleName || !department || !level || !description) {
                alert("Please fill in all required fields.");
                return;
            }

            const newRole = {
                name: roleName,
                role: roleName,
                department,
                level,
                description,
                children: []
            };

            const excomNode = root.descendants().find(d => d.data.name === excom);
            if (parentRole) {
                const parentNode = excomNode._children.find(child => child.name === parentRole);
                if (!parentNode.children) parentNode.children = [];
                parentNode.children.push(newRole);
                if (!parentNode._children) parentNode._children = parentNode.children;
            } else {
                if (!excomNode._children) excomNode._children = [];
                excomNode._children.push(newRole);
                if (!excomNode.children) excomNode.children = excomNode._children;
            }

            sessionStorage.setItem('orgData', JSON.stringify(orgData));
            root = d3.hierarchy(orgData);
            root.descendants().forEach((d, i) => {
                d.id = i;
                d._children = d.children;
                if (d.depth > 2) d.children = null;
            });

            update(root);
            d3.select("#addRoleModal").style("display", "none");
        });

        d3.select("#closeModal").on("click", () => {
            d3.select("#addRoleModal").style("display", "none");
        });

        // PDF Export
        function updatePDFPreviews() {
            const sizes = [
                { id: "previewA4", width: 297, height: 210 },
                { id: "previewA3", width: 420, height: 297 },
                { id: "previewCustom", width: d3.select("#customWidth").property("value") || 297, height: d3.select("#customHeight").property("value") || 210 }
            ];

            sizes.forEach(size => {
                html2canvas(document.querySelector("#organogram"), {
                    scale: 1,
                    width: width,
                    height: height
                }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    const aspectRatio = canvas.width / canvas.height;
                    const maxWidth = 150;
                    const maxHeight = maxWidth / aspectRatio;
                    d3.select(`#${size.id}`)
                        .attr("src", imgData)
                        .attr("width", maxWidth)
                        .attr("height", maxHeight);
                });
            });
        }

        function exportPDF(size) {
            let pageWidth, pageHeight;
            if (size === "a4") {
                pageWidth = 297;
                pageHeight = 210;
            } else if (size === "a3") {
                pageWidth = 420;
                pageHeight = 297;
            } else {
                pageWidth = parseInt(d3.select("#customWidth").property("value")) || 297;
                pageHeight = parseInt(d3.select("#customHeight").property("value")) || 210;
            }

            const nodes = root.descendants();
            const xExtent = d3.extent(nodes, d => d.x);
            const yExtent = d3.extent(nodes, d => d.y);
            const chartWidth = xExtent[1] - xExtent[0] + nodeWidth;
            const chartHeight = yExtent[1] - yExtent[0] + nodeHeight;

            const scaleX = (pageWidth - 20) / chartWidth;
            const scaleY = (pageHeight - 40) / chartHeight;
            const scale = Math.min(scaleX, scaleY);

            html2canvas(document.querySelector("#organogram"), {
                scale: 2,
                width: width,
                height: height
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "mm",
                    format: [pageWidth, pageHeight]
                });

                const margin = 10;
                let yOffset = margin;

                const logo = document.getElementById("logo");
                if (logo.src) {
                    pdf.addImage(logo.src, "PNG", margin, yOffset, 40, 20);
                    yOffset += 25;
                }

                pdf.setFontSize(16);
                pdf.text("TMD Organogram 2025", margin, yOffset);
                yOffset += 10;

                const imgWidth = chartWidth * scale;
                const imgHeight = chartHeight * scale;
                pdf.addImage(imgData, "PNG", margin, yOffset, imgWidth, imgHeight);

                pdf.save(`TMD_Organogram_2025_${size}.pdf`);
                d3.select("#exportPDFModal").style("display", "none");
            });
        }

        d3.select("#exportPDF").on("click", () => {
            d3.select("#exportPDFModal").style("display", "flex");
            updatePDFPreviews();
        });

        d3.selectAll(".downloadPDF").on("click", function() {
            exportPDF(d3.select(this).attr("data-size"));
        });

        d3.select("#closePDFModal").on("click", () => {
            d3.select("#exportPDFModal").style("display", "none");
        });

        d3.select("#customWidth, #customHeight").on("input", updatePDFPreviews);

        // Logo Upload
        d3.select("#uploadLogo").on("click", () => {
            d3.select("#logoUpload").node().click();
        });

        d3.select("#logoUpload").on("change", function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    d3.select("#logo").attr("src", e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Search Functionality
        const searchInput = d3.select("#searchInput");
        const searchResults = d3.select("#searchResults");

        searchInput.on("input", function() {
            const query = this.value.toLowerCase();
            const results = root.descendants().filter(d =>
                d.data.name.toLowerCase().includes(query) ||
                d.data.role.toLowerCase().includes(query) ||
                d.data.department.toLowerCase().includes(query)
            ).slice(0, 10);

            searchResults.style("display", results.length ? "block" : "none")
                .html(results.map(d => `
                    <div class="search-result-item" data-id="${d.id}">
                        <div class="search-result-name">${d.data.name}</div>
                        <div class="search-result-role">${d.data.role} - ${d.data.department}</div>
                    </div>
                `).join(""));

            d3.selectAll(".search-result-item").on("click", function() {
                const id = +d3.select(this).attr("data-id");
                const node = root.descendants().find(d => d.id === id);

                let current = node;
                while (current.parent) {
                    current.parent.children = current.parent._children;
                    current = current.parent;
                }

                update(root);

                const transform = d3.zoomIdentity
                    .translate(width / 2 - node.x * zoomLevel, height / 2 - node.y * zoomLevel)
                    .scale(zoomLevel);

                svg.transition()
                    .duration(650)
                    .call(d3.zoom().transform, transform);

                searchResults.style("display", "none");
                searchInput.property("value", "");
            });
        });

        // Department Highlighting
        d3.selectAll(".legend-item").on("click", function() {
            const dept = d3.select(this).attr("data-dept");
            const isHighlighted = d3.select("body").classed("dept-highlight-mode");

            if (isHighlighted && d3.select(this).classed("active")) {
                d3.select("body").classed("dept-highlight-mode", false);
                d3.selectAll(".legend-item").classed("active", false);
                d3.selectAll(".node, .link").style("opacity", 1);
            } else {
                d3.select("body").classed("dept-highlight-mode", true);
                d3.selectAll(".legend-item").classed("active", false);
                d3.select(this).classed("active", true);
                d3.selectAll(".node, .link").style("opacity", 0.2);
                d3.selectAll(`.dept-${dept}, .dept-${dept}-link`).style("opacity", 1);
            }
        });

        // Initialize Tilt Effect
        VanillaTilt.init(document.querySelector(".controls"), {
            max: 10,
            speed: 400,
            perspective: 1000
        });

        // Initialize Chart
        update(root);
    </script>
</body>
</html>